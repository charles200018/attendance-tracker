<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker - Full Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-8 max-w-6xl">
        <!-- Header with Status -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üìö Attendance Tracker</h1>
            <div id="status" class="text-sm">
                <span id="connection-indicator" class="inline-block px-3 py-1 rounded-full text-white bg-gray-400">
                    Connecting...
                </span>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500 uppercase tracking-wide">Total Classes</div>
                <div id="total-classes" class="text-4xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500 uppercase tracking-wide">Total Students</div>
                <div id="total-students" class="text-4xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-500 uppercase tracking-wide">Attendance Records</div>
                <div id="total-attendance" class="text-4xl font-bold text-purple-600">0</div>
            </div>
        </div>

        <!-- Classes Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üìñ Classes</h2>
            <div class="mb-4 flex gap-2">
                <input type="text" id="class-name-input" placeholder="New class name..." 
                       class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addNewClass()" 
                        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    Add Class
                </button>
            </div>
            <div id="classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Classes will be loaded here -->
            </div>
        </div>

        <!-- Students Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üë®‚Äçüéì Students</h2>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-2">
                <input type="text" id="student-name-input" placeholder="Student name..." 
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="text" id="student-roll-input" placeholder="Roll number..." 
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <select id="student-class-select" 
                        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">Select Class</option>
                </select>
                <button onclick="addNewStudent()" 
                        class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    Add Student
                </button>
            </div>
            <div id="students-container" class="space-y-2">
                <!-- Students will be loaded here -->
            </div>
        </div>

        <!-- Attendance Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">‚úÖ Today's Attendance</h2>
            <div id="attendance-container">
                <!-- Attendance will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:3002/api';
        let classesData = [];
        let studentsData = [];
        let attendanceData = [];

        // Test connection and initialize
        async function initialize() {
            try {
                console.log('Initializing application...');
                const response = await fetch(`${API_URL}/test`);
                const data = await response.json();
                
                document.getElementById('connection-indicator').textContent = 'Connected ‚úì';
                document.getElementById('connection-indicator').className = 
                    'inline-block px-3 py-1 rounded-full text-white bg-green-500';
                
                // Load all data
                await loadAllData();
                
            } catch (error) {
                console.error('Connection failed:', error);
                document.getElementById('connection-indicator').textContent = 'Connection Failed ‚úó';
                document.getElementById('connection-indicator').className = 
                    'inline-block px-3 py-1 rounded-full text-white bg-red-500';
            }
        }

        async function loadAllData() {
            console.log('Loading all data...');
            await Promise.all([
                loadClasses(),
                loadStudents(),
                loadAttendance()
            ]);
            updateStats();
        }

        async function loadClasses() {
            try {
                const response = await fetch(`${API_URL}/classes`);
                classesData = await response.json();
                console.log('Loaded classes:', classesData.length);
                renderClasses();
                updateClassSelect();
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch(`${API_URL}/students`);
                studentsData = await response.json();
                console.log('Loaded students:', studentsData.length);
                renderStudents();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadAttendance() {
            try {
                const response = await fetch(`${API_URL}/attendance`);
                attendanceData = await response.json();
                console.log('Loaded attendance records:', attendanceData.length);
                renderAttendance();
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        function renderClasses() {
            const container = document.getElementById('classes-container');
            if (classesData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">No classes yet. Add one above!</p>';
                return;
            }
            
            container.innerHTML = classesData.map(c => {
                const studentCount = studentsData.filter(s => s.class_id === c.id).length;
                return `
                    <div class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 transition">
                        <div class="font-bold text-lg text-blue-700">${c.name}</div>
                        <div class="text-sm text-gray-600">ID: ${c.id}</div>
                        <div class="text-sm text-gray-600">${studentCount} student(s)</div>
                    </div>
                `;
            }).join('');
        }

        function renderStudents() {
            const container = document.getElementById('students-container');
            if (studentsData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No students yet. Add one above!</p>';
                return;
            }
            
            const groupedByClass = {};
            studentsData.forEach(s => {
                if (!groupedByClass[s.class_id]) {
                    groupedByClass[s.class_id] = [];
                }
                groupedByClass[s.class_id].push(s);
            });
            
            container.innerHTML = Object.entries(groupedByClass).map(([classId, students]) => {
                const className = classesData.find(c => c.id == classId)?.name || 'Unknown Class';
                return `
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-lg text-green-700 mb-2">${className}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${students.map(s => `
                                <div class="p-2 bg-green-50 rounded border border-green-200">
                                    <div class="font-semibold">${s.name}</div>
                                    <div class="text-sm text-gray-600">Roll: ${s.roll}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAttendance() {
            const container = document.getElementById('attendance-container');
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData.filter(a => a.date === today);
            
            if (todayAttendance.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No attendance recorded for today.</p>';
                return;
            }
            
            const groupedByClass = {};
            todayAttendance.forEach(a => {
                if (!groupedByClass[a.class_id]) {
                    groupedByClass[a.class_id] = [];
                }
                groupedByClass[a.class_id].push(a);
            });
            
            container.innerHTML = Object.entries(groupedByClass).map(([classId, records]) => {
                const className = classesData.find(c => c.id == classId)?.name || 'Unknown Class';
                const present = records.filter(r => r.status === 'present').length;
                const absent = records.filter(r => r.status === 'absent').length;
                const late = records.filter(r => r.status === 'late').length;
                
                return `
                    <div class="border rounded-lg p-4 mb-4">
                        <h3 class="font-bold text-lg text-purple-700 mb-2">${className}</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="p-2 bg-green-100 rounded">
                                <div class="text-2xl font-bold text-green-700">${present}</div>
                                <div class="text-sm text-gray-600">Present</div>
                            </div>
                            <div class="p-2 bg-yellow-100 rounded">
                                <div class="text-2xl font-bold text-yellow-700">${late}</div>
                                <div class="text-sm text-gray-600">Late</div>
                            </div>
                            <div class="p-2 bg-red-100 rounded">
                                <div class="text-2xl font-bold text-red-700">${absent}</div>
                                <div class="text-sm text-gray-600">Absent</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateClassSelect() {
            const select = document.getElementById('student-class-select');
            select.innerHTML = '<option value="">Select Class</option>' + 
                classesData.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function updateStats() {
            document.getElementById('total-classes').textContent = classesData.length;
            document.getElementById('total-students').textContent = studentsData.length;
            document.getElementById('total-attendance').textContent = attendanceData.length;
        }

        async function addNewClass() {
            const input = document.getElementById('class-name-input');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a class name');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/classes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                if (!response.ok) throw new Error('Failed to add class');
                
                const newClass = await response.json();
                console.log('Added class:', newClass);
                
                input.value = '';
                await loadClasses();
                alert(`‚úì Class "${newClass.name}" added successfully!`);
                
            } catch (error) {
                console.error('Error adding class:', error);
                alert('Error adding class: ' + error.message);
            }
        }

        async function addNewStudent() {
            const nameInput = document.getElementById('student-name-input');
            const rollInput = document.getElementById('student-roll-input');
            const classSelect = document.getElementById('student-class-select');
            
            const name = nameInput.value.trim();
            const roll = rollInput.value.trim();
            const class_id = classSelect.value;
            
            if (!name || !roll || !class_id) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, roll, class_id })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add student');
                }
                
                const newStudent = await response.json();
                console.log('Added student:', newStudent);
                
                nameInput.value = '';
                rollInput.value = '';
                classSelect.value = '';
                await loadStudents();
                alert(`‚úì Student "${newStudent.name}" added successfully!`);
                
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }

        // Initialize on page load
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
