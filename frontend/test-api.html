<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">API Connection Test</h1>
        
        <div id="status" class="mb-4 p-4 rounded"></div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-2">Classes</h2>
                <div id="classes">Loading...</div>
            </div>
            
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-2">Students</h2>
                <div id="students">Loading...</div>
            </div>
        </div>
        
        <div class="mt-4 bg-white p-4 rounded shadow">
            <h2 class="text-xl font-bold mb-2">Console Log</h2>
            <div id="log" class="font-mono text-sm bg-gray-50 p-2 rounded max-h-96 overflow-auto"></div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:3002/api";
        const logDiv = document.getElementById('log');
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            const entry = document.createElement('div');
            entry.className = 'border-b border-gray-200 py-1';
            entry.textContent = logMessage;
            if (data) {
                entry.textContent += ' ' + JSON.stringify(data);
            }
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testAPI() {
            try {
                log('Testing API connection...');
                log('API URL:', API_URL);
                
                // Test connection
                log('Fetching /api/test...');
                const testResponse = await fetch(`${API_URL}/test`);
                log('Test response status:', testResponse.status);
                const testData = await testResponse.json();
                log('Test response data:', testData);
                
                document.getElementById('status').className = 'mb-4 p-4 rounded bg-green-100 border border-green-400 text-green-700';
                document.getElementById('status').textContent = '✓ API Connection Successful';
                
                // Fetch classes
                log('Fetching classes...');
                const classesResponse = await fetch(`${API_URL}/classes`);
                log('Classes response status:', classesResponse.status);
                const classes = await classesResponse.json();
                log('Classes data:', classes);
                
                document.getElementById('classes').innerHTML = classes.map(c => 
                    `<div class="p-2 bg-gray-50 rounded mb-2">
                        <div class="font-semibold">${c.name}</div>
                        <div class="text-sm text-gray-500">ID: ${c.id}</div>
                    </div>`
                ).join('') || '<p class="text-gray-500">No classes found</p>';
                
                // Fetch students
                log('Fetching students...');
                const studentsResponse = await fetch(`${API_URL}/students`);
                log('Students response status:', studentsResponse.status);
                const students = await studentsResponse.json();
                log('Students data (count):', students.length);
                
                document.getElementById('students').innerHTML = students.slice(0, 5).map(s => 
                    `<div class="p-2 bg-gray-50 rounded mb-2">
                        <div class="font-semibold">${s.name}</div>
                        <div class="text-sm text-gray-500">Roll: ${s.roll} | Class: ${s.class_id}</div>
                    </div>`
                ).join('') + (students.length > 5 ? `<p class="text-sm text-gray-500 mt-2">...and ${students.length - 5} more</p>` : '');
                
                log('✓ All data loaded successfully');
                
            } catch (error) {
                log('ERROR:', error.message);
                console.error('Full error:', error);
                
                document.getElementById('status').className = 'mb-4 p-4 rounded bg-red-100 border border-red-400 text-red-700';
                document.getElementById('status').innerHTML = `✗ API Connection Failed<br><small>${error.message}</small>`;
                
                document.getElementById('classes').innerHTML = '<p class="text-red-500">Failed to load</p>';
                document.getElementById('students').innerHTML = '<p class="text-red-500">Failed to load</p>';
            }
        }
        
        // Run test on page load
        log('Page loaded, starting API test...');
        testAPI();
    </script>
</body>
</html>
